# Redfish Generator for Facebook OpenBMC Platform

Author:
  Leila Lin <leila.lin@deltaww.com>

Other contributors:
  Zoie Lin <zoie.lin@deltaww.com>

Created:
  2021-01-10

## Proposal Description
The BMC on switch platform monitors lots of devices, which its data has to be exposed in clean, human readable and standardized format. This document focuses on how Redfish been generated and implemented with platform description file, since it is standard API for platform manageability.<br>
The proposal called Shim Layer is to implement functions Redfish would use and also are planning to support functions that demands by facebook/openbmc platform library (obmc-pal). The composition of shim layer were created and generated by generator, and this generator would create a platform description file by a JSON format platform descriptor.

## Background and References
* Based on facebook/openbmc Yocto Project Environment
* Based on facebook/openbmc RESTful API utility (rest-api-1) and aiohttp web service.
* Leverage facebook/openbmc rest-api-1 to support Redfish output format.
* To apply to DMTF Redfish Model, Redfish generator shall leverage platform description file parsing to platform devices information.

## Proposed Design
* Including Files

```ascii
   +------------+
   |Facebook|   |
   |Common  |   |
   +--------/   |
   +------------+                                     +------------+
            |                                  +----->|rest-api|   |
            |                                  |      +--------/   |
            |                                  |      +------------+
            |                                  |
            |                                  |      +------------+
            |        +----------------+        |----->|shim-gen|   |
            +------->|recipes-shim|   |        |      +--------/   |
                     +------------/   +--------|      +------------+
                     +                |        |
                     +----------------+        |
                                               |      +------------+
                                               |----->|shim-lib|   |
                                               |      +--------/   |
                                               |      +------------+
                                               |
                                               |      +------------+
                                               +----->|redfish |   |
                                                      +--------/   |
                                                      +------------+
```
```ascii
/openbmc/common
└	recipes-shim
    └	delta-gen: Process platform description files.
        └	bmc_sensor: Attribute definition of Sensor Objects
        └	config_parser: Parse Platform Descriptor and compose Redfish route table and responding handler.
        └	shim_list: Header of shim layer.
        └	device_item: Compose device items information
    └	delta-lib: APIs.
    └	redfish: Library mapped to Redfish routes.
    └	rest-api: Apply generated Redfish into original RESTful API design.
```
* Generate Flow

The composition of shim layer were created and generated by generator, and this generator would create a platform description file by a JSON format platform descriptor. Generator provides the description of devices of platform. In the meantime, it creates URI route table and responding endpoints as Redfish model specified.<br>
Once a new platform is porting facebook/openbmc with shim layer, the platform would support Redfish model with platform descriptor providing.

```ascii
   +-----------------------+
   |       Descriptor      |
   |   +---------------+   |
   |   |<platform>.json|   |
   |   +---------------/   |
   +-----------------------+
              |
              |
              |
              v
   +-------------------------+             +-----------------+
   |        Generator        |             |   Shim Layer    |
   |   +-----------------+   |             |  +-----------+  |
   |   |config_parser.py |   |     +------>|  |shim_lib.h |  |
   |   +-----------------/   |     |       |  +-----------/  |
   |                         |     |       |  +-----------+  |
   |   +-----------------+   |     |       |  |shim_lib.c |  |
   |   |bmc_manager.py   |   |     |       |  +-----------/  |
   |   +-----------------/   |     |       |  +-----------+  |
   |                         |     |       |  |shim_list.h|  |
   |   +-----------------+   |     |       |  +-----------/  |
   |   |bmc_sensor.py    |   |     |       +-----------------+
   |   +-----------------/   |     |                 ^
   |                         |-----|       +-----------------------------------+
   |   +-----------------+   |     |       |        Redfish Feature API        |
   |   +-----------------+   |     |       |  +-----------------------------+  |
   |   |device_item.py   |   |     |       |  |Formatted Output Construction|  |
   |   +-----------------/   |     |       |  |(ex. redfish_feature.py)     |  |
   |                         |     |       |  +-----------------------------/  |
   |   +-----------------+   |     |       |                ^                  |
   |   |pal_generator.py |   |     |       |                ^                  |
   |   +-----------------/   |     |       |     URI Route Table & Endpoint    |
   |                         |     |       |  +-----------------------------+  |
   |   +-----------------+   |     |       |  |redfishroutes.py             |  |
   |   |handler_mapper.py|   |     +-------|->|redfish_setup_routes.py      |  |
   |   +-----------------/   |             |  |redfish_endpoint.py          |  |
   +-------------------------+             |  +-----------------------------/  |
                                           +-----------------------------------+
```

## Descriptor of Platform
* Example of Shim Layer Descriptor
```json
{
    "redfish/v1": {
        "Chassis": {
            "1": {
                "Thermal": {
                    "Fans": [{
                            "name": "Fan 1 Front",
                            "threshold": [13000, 0, 0, 6600, 0, 0],
                            "min": 960,
                            "max": 23000,
                            "dev": {
                                "addr": "3-006e",
                                "driver": "emc23xx",
                                "rpm": "fan1_input",
                                "pwm": "pwm1"
                            },
                            "gpio": {
                                "present": "FAN1_PRESENT",
                                "present_mask": ["0x1", "0x0"]
                            }
                        },
                        {
                            "name": "Fan 1 Rear",
                            "threshold": [13000, 0, 0, 6600, 0, 0],
                            "min": 960,
                            "max": 23000,
                            "dev": {
                                "addr": "3-005e",
                                "driver": "emc23xx",
                                "rpm": "fan2_input",
                                "pwm": "pwm2"
                            },
                            "gpio": {
                                "present": "FAN1_PRESENT",
                                "present_mask": ["0x1", "0x0"]
                            }
                        }
                    ],
                    "Temperatures": [{
                            "name": "RF Temp",
                            "threshold": [80, 0, 0, 0, 0, 0],
                            "min": -40,
                            "max": 125,
                            "dev": {
                                "addr": "4-0012",
                                "driver": "lm75",
                                "celsius": "hwmon/hwmon*/temp1_input"
                            }
                        },
                        {
                            "name": "LF Temp",
                            "threshold": [80, 0, 0, 0, 0, 0],
                            "min": -40,
                            "max": 125,
                            "dev": {
                                "addr": "4-003a",
                                "driver": "lm75",
                                "celsius": "hwmon/hwmon*/temp1_input"
                            }
                        }
                    ]
                },
                "Power": {
                    "PowerControl": [{
                            "name": "PSU1",
                            "interval": 10,
                            "dev": {
                                "addr": "0-0058",
                                "driver": "dps_driver",
                                "comsumpt": "read_pout"
                            },
                            "cpld": {
                                "addr": "7-0032",
                                "driver": "swpld_1",
                                "present": "psu1_present",
                                "present_mask": ["0x0", "0x0"]
                            },
                            "gpio": {},
                            "plat": {}
                        }
                    ],
                    "Voltage": [{
                            "name": "ADC_VCC_12V",
                            "threshold": [1428, 0, 0, 1169, 0, 0],
                            "min": 0,
                            "max": 1500,
                            "dev": {},
                            "cpld": {},
                            "gpio": {},
                            "plat": {
                                "adc": "hwmon/hwmon*/in1_input",
                                "driver": "ast-adc-hwmon"
                            }
                        },
                        {
                            "name": "ADC_VCC_5V",
                            "threshold": [1446, 0, 0, 1183, 0, 0],
                            "min": 0,
                            "max": 1500,
                            "plat": {
                                "adc": "hwmon/hwmon*/in2_input",
                                "driver": "ast-adc-hwmon"
                            }
                        },
                    ],
                    "PowerSupplies": [{
                            "name": "PSU1",
                            "dev": {
                                "addr": "0-0058",
                                "driver": "dps_driver",
                                "fw_ver": "mfr_rev",
                                "vin": "read_vin",
                                "mfr": "mfr_id",
                                "model": "mfr_model",
                                "serial": "mfr_serial"
                            },
                            "cpld": {
                                "addr": "7-0032",
                                "driver": "swpld_1",
                                "state": "psu1_state",
                                "state_mask": ["0x0", "0x0"]
                            },
                            "gpio": {},
                            "plat": {}
                        }
                    ]
                }
            }
        }
    }
}
```
## Supported Redfish API
* /redfish/v1/
* /redfish/v1/Chassis
* /redfish/v1/Chassis/{ChassisId}
* /redfish/v1/Chassis/{ChassisId}/Thermal
* /redfish/v1/Chassis/{ChassisId}/Thermal#/Temperatures/{SensorName}
* /redfish/v1/Chassis/{ChassisId}/Thermal#/Fans/{FanName}
* /redfish/v1/Chassis/{ChassisId}/Power
* /redfish/v1/Chassis/{ChassisId}/Power#/PowerControl/{ControlName}
* /redfish/v1/Chassis/{ChassisId}/Power#/Voltages/{VoltageName}
* /redfish/v1/Chassis/{ChassisId}/Power#/PowerSupplies/{PSUName}
